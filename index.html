<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COESC Receipt Encoder</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="bg-data.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  

<style>
/* ================= CSS STYLES ================= */
:root {
  --primary: #003366;
  --secondary: #f4f4f9;
  --radius: 8px;
  --poppins: 'Poppins', sans-serif;
  /* ADD THESE TWO LINES */
  --a6-width: 800px; 
  --a6-height: 565px;
}

body {
  margin: 0;
  padding: 20px;
  font-family: var(--poppins); /* Changed from Segoe UI */
  background: var(--secondary);
  color: #333;
}

/* Ensure all interactive elements inherit Poppins */
input, select, button, label, h1 {
  font-family: var(--poppins);
}

.container {
  max-width: 1200px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: var(--radius);
  box-shadow: 0 4px 15px rgba(0,0,0,.1);
}

header {
  text-align: center;
  margin-bottom: 30px;
  border-bottom: 2px solid var(--primary);
  padding-bottom: 15px;
}

h1 {
  margin: 0;
  color: var(--primary);
  text-transform: uppercase;
  font-weight: 700; /* Made slightly bolder for Poppins style */
}

label {
  font-size: 14px;
  font-weight: 600;
  display: block;
  margin-bottom: 5px;
}

input, select {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.read-only {
  background: #e9ecef;
  cursor: not-allowed;
}

.form-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.full {
  grid-column: 1 / -1;
}

.checkbox-group {
  display: flex;
  gap: 15px;
  align-items: center;
}

/* BUTTONS */
.btn-group{display:flex;gap:10px;margin-top:20px;}
button{padding:10px 20px;border:none;border-radius:4px;font-weight:700;cursor:pointer;}
.btn-save{background:var(--primary);color:#fff;flex:2;}
.btn-clear{background:#6c757d;color:#fff;flex:1;}
.btn-print{background:#28a745;color:#fff;}
.btn-png{background:#e67e22;color:#fff;}
  .btn-vault {
  background: #5d6d7e; /* Professional slate gray */
  color: #fff;
  flex: 1;
}

/* Hover effect for all buttons */
button:hover {
  opacity: 0.9;
  transform: translateY(-1px);
  transition: 0.2s;
}

/* TABLE */
.table-responsive{overflow-x:auto;margin-top:30px;}
table{width:100%;border-collapse:collapse;font-size:13px;white-space:nowrap;}
th,td{padding:12px 10px;border-bottom:1px solid #ddd;text-align:left;}
th{background:var(--primary);color:#fff;}

/* RECEIPT PREVIEW */
#print-area{margin-top:40px;display:flex;justify-content:center;}
#receipt-container {
  width: var(--a6-width);
  height: var(--a6-height);
  position: relative;
  box-shadow: 0 0 20px rgba(0,0,0,.15);
  /* Remove the background line from here if you are using bg-data.js */
  background-color: #ffffff; 
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  print-color-adjust: exact;
  -webkit-print-color-adjust: exact;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

/* POSITIONING CLASSES */
.field {
  position: absolute;
  transform: translate(-50%, -50%);
  font-family: 'Poppins', sans-serif;
  font-weight: 700;
  font-size: 15px; /* Adjust size if needed */
  white-space: nowrap;
  pointer-events: none;
}

/* PRINT SETTINGS */
@media print {
  /* Hide everything else on the page */
  body > *:not(#print-area) {
    display: none !important;
  }

  /* Show the receipt container and everything inside it */
  #print-area,
  #print-area * {
    display: block !important;
    visibility: visible !important;
  }

  /* Position the receipt exactly at the top-left of the page */
  #receipt-container {
    width: 148mm !important;   /* A6 width */
    height: 105mm !important;  /* A6 height */
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    box-shadow: none !important; /* Remove shadow on print */
  }

  /* Remove margins/padding of the print area */
  #print-area {
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Set the page size to A6 exactly */
  @page {
    size: 148mm 105mm;
    margin: 0;
  }
}
</style>
</head>
<body>

<div class="container">
<header>
  <h1>COESC Receipt Encoder</h1>
  <p>College of Education Student Council</p>
</header>

<h2>üìù Encode New Receipt</h2>
<div class="form-section">
  <div class="full">
    <label>Transaction Category</label>
    <select id="category" onchange="toggleFields(); genIds();">
    <option value="Merchandise" selected>Merchandise</option>
    <option value="Others">Others</option>
</select>
  </div>
  <div><label>Receipt Code</label><input id="receiptCode" class="read-only" readonly></div>
  <div><label>Date</label><input type="date" id="date" oninput="syncReceipt()"></div>
  <div class="full">
    <label>Received From</label>
    <input id="receivedFrom" oninput="syncReceipt(); genIds();">
</div>
  <div><label>Amount (PHP)</label><input type="number" id="amount" step="0.01" oninput="syncReceipt()"></div>
  <div><label>Received By</label><input id="receivedBy" oninput="syncReceipt()"></div>
  <div class="full"><label>Description</label><input id="desc" oninput="syncReceipt()"></div>

  <div id="merchFields" class="form-section full">
    <div><label>Order No</label><input id="orderNo" class="read-only" readonly></div>
    <div><label>Merch Item</label><input id="merchItem" oninput="syncReceipt()"></div>
    <div><label>Quantity</label><input type="number" id="qty" value="1" oninput="syncReceipt()"></div>
    <div><label>Balance</label><input type="number" id="balance" step="0.01" oninput="syncReceipt()"></div>
    <div class="full">
      <label>Mode of Payment</label>
      <div class="checkbox-group">
        <label><input type="checkbox" id="modeDown" onchange="syncReceipt()"> Downpayment</label>
        <label><input type="checkbox" id="modeFull" onchange="syncReceipt()"> Full Payment</label>
      </div>
    </div>
  </div>
</div>

<div class="btn-group">
  <button class="btn-clear" onclick="resetForm()">Clear</button>
  <button class="btn-save" onclick="saveReceipt()">Save Record</button>
  <button class="btn-vault" onclick="window.open('records.html', '_blank')">üìÇ View Records</button>
  <button class="btn-print" onclick="finalPrint()">Print Receipt</button>
  <button class="btn-png" onclick="downloadImage()">Save as PNG</button>
</div>

<div id="print-area">
  <div id="receipt-container">
    <img id="hd-bg" src="" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; object-fit: fill;">
    
    <div class="field" id="f_code" style="z-index:1;"></div>
    <div class="field" id="f_date" style="z-index:1;"></div>
    <div class="field" id="f_from" style="z-index:1;"></div>
    <div class="field" id="f_amtWord" style="z-index:1;"></div>
    <div class="field" id="f_amtNum" style="z-index:1;"></div>
    <div class="field" id="f_desc" style="z-index:1;"></div>
    <div class="field" id="f_ord" style="z-index:1;"></div>
    <div class="field" id="f_merch" style="z-index:1;"></div>
    <div class="field" id="f_qty" style="z-index:1;"></div>
    <div class="field" id="f_bal" style="z-index:1;"></div>
    <div class="field" id="f_down" style="z-index:1;"></div>
    <div class="field" id="f_full" style="z-index:1;"></div>
    <div class="field" id="f_by" style="z-index:1;"></div>
  </div>
</div>

<script>

let rNum = parseInt(localStorage.getItem('rNum')) || 1;
let oNum = parseInt(localStorage.getItem('oNum')) || 1;
let isEditing = false;
let receipts = JSON.parse(localStorage.getItem('coesc_receipts')) || [];

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_E5rdVdJIyjxgvzo_cKd2BN8o_sCpg-R4xOxFpT0Fzfk-MPyLX-FkR1wm3KDv5d_o/exec';

const pos = {
    f_code: [23.25, 31.23], f_date: [22.7, 83.9], f_from: [34.7, 61.7], 
    f_amtWord: [45.6, 42.8], f_amtNum: [45.6, 89.4], f_desc: [57.2, 62.3], 
    f_ord: [75, 22], f_merch: [83, 22], f_qty: [90.7, 22], 
    f_bal: [90.3, 49.8], f_down: [75, 41], f_full: [83, 41], f_by: [87.4, 77.7]
};

window.onload = function() {
    init();

    // Check if we arrived here from the "Load" button in records.html
    const editData = localStorage.getItem('edit_record');
    if (editData) {
        const data = JSON.parse(editData); // Fill the form
        localStorage.removeItem('edit_record'); // Clear it so it doesn't stay forever
        alert("Record Loaded! You can now Print, Save as PNG, or Edit and Save.");
    }
};

function init() {
    // Force the image to load the Base64 data
    const bg = document.getElementById('hd-bg');
    if (bg && typeof receiptBase64 !== 'undefined') {
        bg.src = receiptBase64;
        console.log("Background Image Loaded Successfully");
    } else {
        console.error("receiptBase64 is missing! Check your bg-data.js file.");
    }

    // Ensure the container itself is transparent so the image behind it shows
    const container = document.getElementById('receipt-container');
    container.style.backgroundColor = "white"; // Solid white base
    container.style.backgroundImage = "none";  // Remove CSS background to avoid conflicts

    // Default Date & IDs
    const dateInput = document.getElementById('date');
    if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];

    genIds();
    applyPositions();
    toggleFields();
}
function applyPositions() {
    Object.keys(pos).forEach(id => {
        const e = document.getElementById(id);
        if (e) {
            e.style.top = pos[id][0] + '%';
            e.style.left = pos[id][1] + '%';
        }
    });
}

function genIds() {
    if (isEditing) return;
    const receiptField = document.getElementById('receiptCode');
    const orderField = document.getElementById('orderNo');
    const categoryField = document.getElementById('category');

    if (receiptField) receiptField.value = "COESC-2026-" + String(rNum).padStart(4, '0');

    if (categoryField.value === "Merchandise") {
        if (orderField && !orderField.value) orderField.value = "ORD-" + String(oNum).padStart(3, '0');
    } else {
        if (orderField) orderField.value = "";
    }
    syncReceipt();
}

function toggleFields() {
    const isMerch = document.getElementById('category').value === 'Merchandise';
    document.getElementById('merchFields').style.display = isMerch ? 'grid' : 'none';
    
    const descField = document.getElementById('desc');
    if (isMerch) {
        descField.value = 'MERCHANDISE';
        descField.readOnly = true;
        descField.classList.add('read-only');
    } else {
        descField.readOnly = false;
        descField.classList.remove('read-only');
    }
    syncReceipt();
}

function toWords(num) {
    if (!num || num == 0) return "ZERO";
    const ones = ["","ONE","TWO","THREE","FOUR","FIVE","SIX","SEVEN","EIGHT","NINE"];
    const teens = ["TEN","ELEVEN","TWELVE","THIRTEEN","FOURTEEN","FIFTEEN","SIXTEEN","SEVENTEEN","EIGHTEEN","NINETEEN"];
    const tens = ["","","TWENTY","THIRTY","FORTY","FIFTY","SIXTY","SEVENTY","EIGHTY","NINETY"];
    function convert(n) {
        if (n < 10) return ones[n];
        if (n < 20) return teens[n - 10];
        if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? " " + ones[n % 10] : "");
        if (n < 1000) return ones[Math.floor(n / 100)] + " HUNDRED" + (n % 100 ? " AND " + convert(n % 100) : "");
        return "";
    }
    let res = "";
    if (num >= 1000) { res += convert(Math.floor(num / 1000)) + " THOUSAND "; num %= 1000; }
    if (num > 0) res += convert(num);
    return res.trim().toUpperCase();
}

function syncReceipt() {
    const dateVal = document.getElementById('date').value;
if (dateVal) {
    const d = new Date(dateVal);
    document.getElementById('f_date').textContent =
        (d.getMonth() + 1) + "/" + d.getDate();
} else {
    document.getElementById('f_date').textContent = "";
}

    document.getElementById('f_date').textContent = (d.getMonth() + 1) + "/" + d.getDate();
    document.getElementById('f_from').textContent = document.getElementById('receivedFrom').value.toUpperCase();
    document.getElementById('f_by').textContent = document.getElementById('receivedBy').value.toUpperCase();
    document.getElementById('f_desc').textContent = document.getElementById('desc').value.toUpperCase();
    document.getElementById('f_code').textContent = document.getElementById('receiptCode').value.split('-').pop();

    const isMerch = document.getElementById('category').value === 'Merchandise';
    if (isMerch) {
        document.getElementById('f_ord').textContent = document.getElementById('orderNo').value;
        document.getElementById('f_merch').textContent = document.getElementById('merchItem').value.toUpperCase();
        document.getElementById('f_qty').textContent = document.getElementById('qty').value;
        document.getElementById('f_bal').textContent = document.getElementById('balance').value ? "‚Ç± " + Number(document.getElementById('balance').value).toFixed(2) : "";
        document.getElementById('f_down').textContent = document.getElementById('modeDown').checked ? "‚úî" : "";
        document.getElementById('f_full').textContent = document.getElementById('modeFull').checked ? "‚úî" : "";
    } else {
        ["f_ord", "f_merch", "f_qty", "f_bal", "f_down", "f_full"].forEach(id => document.getElementById(id).textContent = "");
    }

    const amt = document.getElementById('amount').value;
    document.getElementById('f_amtNum').textContent = amt ? Number(amt).toFixed(2) : "0.00";
    document.getElementById('f_amtWord').textContent = amt ? toWords(Math.floor(amt)) : "ZERO";
}

async function saveReceipt() {
    const category = document.getElementById('category').value;
    
    // --- FIX FOR MODE OF PAYMENT ---
    let modes = [];
    if(document.getElementById('modeDown').checked) modes.push("Downpayment");
    if(document.getElementById('modeFull').checked) modes.push("Full Payment");
    let finalMode = modes.length > 0 ? modes.join(" & ") : "N/A";

    const data = {
    receiptCode: document.getElementById('receiptCode').value || "N/A",
    date: document.getElementById('date').value || new Date().toISOString(),
    receivedFrom: document.getElementById('receivedFrom').value || "N/A",
    amountInNumber: document.getElementById('amount').value || 0,
    amountInWords: toWords(Math.floor(document.getElementById('amount').value || 0)),
    description: document.getElementById('desc').value || "N/A",
    receivedBy: document.getElementById('receivedBy').value || "N/A",
    orderNumber: document.getElementById('orderNo').value || "N/A",
    merch: document.getElementById('merchItem').value || "N/A",
    modeOfPayment: finalMode || "N/A", // Ensure finalMode is defined
    balance: document.getElementById('balance').value || 0
};

    if (!data.receivedFrom) return alert("Please enter a name.");

    try {
        // Send to Google Sheets
        await fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(data) 
        });
        
        // Update Local Counters
        if (!isEditing) {
            rNum++;
            if (category === 'Merchandise') oNum++;
            localStorage.setItem('rNum', rNum);
            localStorage.setItem('oNum', oNum);
        }

        alert("‚úÖ Saved to Cloud!");
        isEditing = false;
        
        // UI Updates
        resetForm();
        genIds();;
        
    } catch (e) {
        alert("Error saving: " + e.message);
    }
}

function resetForm() {
    isEditing = false;

    document.getElementById('category').value = "Merchandise";
    toggleFields();

    [
        "receivedFrom",
        "amount",
        "receivedBy",
        "merchItem",
        "balance",
        "desc",
        "orderNo"
    ].forEach(id => document.getElementById(id).value = "");

    document.getElementById('modeDown').checked = false;
    document.getElementById('modeFull').checked = false;

    genIds();
    syncReceipt();
}

function downloadImage() {
    // Target ONLY the receipt-container, NOT the whole page or 'container'
    const target = document.getElementById('receipt-container');
    
    html2canvas(target, { 
        scale: 3, 
        useCORS: true, 
        allowTaint: true,
        backgroundColor: "#ffffff",
        // This ensures it only captures the actual dimensions of the receipt
        width: 800, 
        height: 565 
    }).then(canvas => {
        const link = document.createElement('a');
        const code = document.getElementById('receiptCode').value || 'COESC_Receipt';
        link.download = code + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}
  function finalPrint() {
    const bg = document.getElementById('hd-bg');
    if (bg.complete) {
        window.print();
    } else {
        bg.onload = () => window.print();
    }
}
</script>
</body>
</html>










































